<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Konfiguration Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2d4a22 0%, #4a5c3a 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #5a7c47 0%, #3d5a2e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .content { padding: 30px; }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #5a7c47;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .pdf-selector {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #5a7c47;
        }
        .pdf-dropdown {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }
        .pdf-dropdown:focus {
            outline: none;
            border-color: #5a7c47;
        }
        
        .config-editor {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 30px;
            min-height: 600px;
        }
        
        .groups-panel, .fields-panel, .properties-panel {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e1e5e9;
        }
        
        .panel-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .group-item, .field-item {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .group-item:hover, .field-item:hover {
            border-color: #5a7c47;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .group-item.active, .field-item.active {
            border-color: #5a7c47;
            background: #f0f8ff;
        }
        .group-item:active, .field-item:active {
            cursor: grabbing;
        }
        
        .drag-handle {
            color: #999;
            cursor: grab;
        }
        .group-name, .field-name {
            flex: 1;
            font-weight: 600;
        }
        .group-count {
            background: #5a7c47;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        .field-type {
            background: #17a2b8;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        .field-mapped {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        .field-hidden {
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        
        .add-group-btn, .delete-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .add-group-btn {
            background: #28a745;
            color: white;
            width: 100%;
            margin-bottom: 15px;
        }
        .add-group-btn:hover {
            background: #218838;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
            font-size: 0.8em;
            padding: 4px 8px;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        
        .properties-form {
            display: none;
        }
        .properties-form.active {
            display: block;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #5a7c47;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }
        
        .unassigned-fields {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .unassigned-title {
            font-weight: 700;
            color: #856404;
            margin-bottom: 10px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e1e5e9;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #5a7c47 0%, #3d5a2e 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(90, 124, 71, 0.3);
        }
        .btn-secondary {
            background: #f8f9ff;
            color: #5a7c47;
            border: 2px solid #5a7c47;
        }
        .btn-secondary:hover {
            background: #5a7c47;
            color: white;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .sortable-ghost {
            opacity: 0.5;
        }
        .sortable-chosen {
            border-color: #5a7c47 !important;
            background: #f0f8ff !important;
        }
        
        @media (max-width: 1200px) {
            .config-editor {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PDF Konfiguration Editor</h1>
            <p>Erstellen und bearbeiten Sie YAML-Konfigurationen f√ºr PDF-Formulare</p>
        </div>
        
        <div class="content">
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <p>Lade PDF-Formulare...</p>
            </div>
            
            <div id="mainContent" style="display: none;">
                <div class="pdf-selector">
                    <h3>üìÑ PDF-Formular ausw√§hlen</h3>
                    <select id="pdfSelector" class="pdf-dropdown" onchange="loadPDFConfig()">
                        <option value="">-- PDF ausw√§hlen --</option>
                    </select>
                </div>
                
                <div id="configEditor" class="config-editor" style="display: none;">
                    <!-- Gruppen Panel -->
                    <div class="groups-panel">
                        <div class="panel-title">
                            üìÅ Gruppen
                        </div>
                        <button class="add-group-btn" onclick="addNewGroup()">
                            ‚ûï Neue Gruppe
                        </button>
                        <div id="groupsList"></div>
                    </div>
                    
                    <!-- Felder Panel -->
                    <div class="fields-panel">
                        <div class="panel-title">
                            üìù Felder
                            <span id="selectedGroupName"></span>
                        </div>
                        <div id="fieldsContainer">
                            <div id="fieldsList"></div>
                            <div id="unassignedFields" class="unassigned-fields" style="display: none;">
                                <div class="unassigned-title">üóÉÔ∏è Nicht zugewiesene Felder</div>
                                <div id="unassignedFieldsList"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Eigenschaften Panel -->
                    <div class="properties-panel">
                        <div class="panel-title">
                            ‚öôÔ∏è Eigenschaften
                        </div>
                        
                        <!-- Gruppen-Eigenschaften -->
                        <div id="groupProperties" class="properties-form">
                            <div class="form-group">
                                <label for="groupTitle">Titel:</label>
                                <input type="text" id="groupTitle" placeholder="z.B. Pers√∂nliche Daten">
                            </div>
                            <div class="form-group">
                                <label for="groupDescription">Beschreibung:</label>
                                <textarea id="groupDescription" placeholder="Beschreibung der Gruppe"></textarea>
                            </div>
                            <button class="delete-btn" onclick="deleteGroup()" style="width: 100%; margin-top: 10px;">
                                üóëÔ∏è Gruppe l√∂schen
                            </button>
                        </div>
                        
                        <!-- Feld-Eigenschaften -->
                        <div id="fieldProperties" class="properties-form">
                            <div class="form-group">
                                <label for="fieldTitle">Titel:</label>
                                <input type="text" id="fieldTitle" placeholder="Angezeigter Name">
                            </div>
                            <div class="form-group">
                                <label for="fieldDescription">Beschreibung:</label>
                                <textarea id="fieldDescription" placeholder="Hilfetext f√ºr das Feld"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="fieldType">Typ:</label>
                                <select id="fieldType">
                                    <option value="text">Text</option>
                                    <option value="email">E-Mail</option>
                                    <option value="tel">Telefon</option>
                                    <option value="date">Datum</option>
                                    <option value="number">Zahl</option>
                                    <option value="checkbox">Checkbox</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fieldMapping">Mapping:</label>
                                <input type="text" id="fieldMapping" placeholder="Anderer Feldname (optional)">
                            </div>
                            <div class="form-group">
                                <label for="fieldCalculation">Berechnung:</label>
                                <input type="text" id="fieldCalculation" placeholder='z.B. CONCAT({Vorname}, " ", {Nachname})'>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="fieldHidden">
                                    <label for="fieldHidden">Feld verstecken</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="saveConfig()">üíæ Konfiguration speichern</button>
                    <button class="btn btn-secondary" onclick="downloadConfig()">üì• YAML herunterladen</button>
                    <button class="btn btn-secondary" onclick="previewConfig()">üëÅÔ∏è Vorschau</button>
                </div>
                
                <div id="status" class="status"></div>
            </div>
        </div>
    </div>

    <script>
        let availablePDFs = [];
        let currentPDF = null;
        let currentConfig = { fields: {}, groups: {} };
        let currentGroup = null;
        let currentField = null;
        let groupsOrder = [];
        let fieldsOrder = {};

        window.addEventListener('load', async function() {
            await initializeApp();
        });

        async function initializeApp() {
            try {
                await loadPDFsFromDirectory();
                populatePDFSelector();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } catch (error) {
                console.error('Fehler beim Initialisieren:', error);
                showStatus('Fehler beim Laden der PDF-Formulare: ' + error.message, 'error');
            }
        }

        async function loadPDFsFromDirectory() {
            const dirResponse = await fetch('./formulare/');
            if (!dirResponse.ok) {
                throw new Error('Verzeichnis ./formulare/ nicht erreichbar');
            }
            
            const dirHTML = await dirResponse.text();
            const pdfNames = extractPDFNamesFromListing(dirHTML);
            
            if (pdfNames.length === 0) {
                throw new Error('Keine PDF-Dateien gefunden');
            }
            
            for (const pdfName of pdfNames) {
                try {
                    const response = await fetch(`./formulare/${encodeURIComponent(pdfName)}`);
                    if (response.ok) {
                        const arrayBuffer = await response.arrayBuffer();
                        const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                        const fields = await extractFieldsFromPDF(pdfDoc, pdfName);
                        
                        availablePDFs.push({
                            name: pdfName,
                            path: `./formulare/${pdfName}`,
                            fields: fields
                        });
                    }
                } catch (error) {
                    console.warn(`Fehler beim Laden von ${pdfName}:`, error);
                }
            }
            
            if (availablePDFs.length === 0) {
                throw new Error('Keine PDF-Formulare konnten geladen werden');
            }
        }

        function extractPDFNamesFromListing(html) {
            const pdfNames = [];
            const linkRegex = /<a href="([^"]+\.pdf)"/gi;
            let match;
            
            while ((match = linkRegex.exec(html)) !== null) {
                pdfNames.push(decodeURIComponent(match[1]));
            }
            
            return pdfNames;
        }

        async function extractFieldsFromPDF(pdfDoc, pdfName) {
            const extractedFields = [];
            
            try {
                const form = pdfDoc.getForm();
                const fields = form.getFields();
                
                for (const field of fields) {
                    extractedFields.push(field.getName());
                }
            } catch (error) {
                console.log(`Keine Formularfelder in ${pdfName} gefunden`);
            }
            
            // Fallback f√ºr bekannte PDFs ohne erkennbare Felder
            if (extractedFields.length === 0) {
                if (pdfName.includes('5119') || pdfName.includes('Arbeitgeber') || pdfName.includes('EV')) {
                    extractedFields.push(
                        'NameDesUnternehmens', 'Datum', 'VornameDerReservistinDesReservisten',
                        'NachnameDerReservistinDesReservisten', 'NameDerReservistinDesReservisten',
                        'Personenkennziffer', 'Personalnummer', 'StrasseHausnummer',
                        'PostleitzahlWohnort', 'EMailAdresse', 'Telefonnummer',
                        'fromDate1', 'toDate1', 'fromDate2', 'toDate2', 'fromDate3', 'toDate3',
                        'Ort', 'DatumDate2', 'JahrEinverstanden'
                    );
                }
            }
            
            return [...new Set(extractedFields)];
        }

        function populatePDFSelector() {
            const selector = document.getElementById('pdfSelector');
            availablePDFs.forEach(pdf => {
                const option = document.createElement('option');
                option.value = pdf.name;
                option.textContent = `${pdf.name} (${pdf.fields.length} Felder)`;
                selector.appendChild(option);
            });
        }

        async function loadPDFConfig() {
            const selector = document.getElementById('pdfSelector');
            const selectedPDF = selector.value;
            
            if (!selectedPDF) {
                document.getElementById('configEditor').style.display = 'none';
                return;
            }
            
            currentPDF = availablePDFs.find(pdf => pdf.name === selectedPDF);
            if (!currentPDF) return;
            
            // Versuche existierende Konfiguration zu laden
            await loadExistingConfig(selectedPDF);
            
            // Editor anzeigen und initialisieren
            document.getElementById('configEditor').style.display = 'grid';
            initializeEditor();
        }

        async function loadExistingConfig(pdfName) {
            try {
                const configName = pdfName.replace('.pdf', '.yaml');
                const response = await fetch(`./formulare/${encodeURIComponent(configName)}`);
                if (response.ok) {
                    const yamlText = await response.text();
                    currentConfig = jsyaml.load(yamlText) || { fields: {}, groups: {} };
                    showStatus('Existierende Konfiguration geladen', 'success');
                } else {
                    // Neue Konfiguration mit Standard-Gruppen
                    currentConfig = {
                        fields: {},
                        groups: {
                            'Pers√∂nliche Daten': {
                                title: 'üë§ Pers√∂nliche Angaben',
                                description: 'Grundlegende pers√∂nliche Informationen'
                            },
                            'Kontaktdaten': {
                                title: 'üìû Kontaktinformationen', 
                                description: 'Wie k√∂nnen wir Sie erreichen?'
                            },
                            'Sonstige': {
                                title: 'üìã Sonstige Felder',
                                description: 'Weitere Informationen'
                            }
                        }
                    };
                    showStatus('Neue Konfiguration erstellt', 'success');
                }
            } catch (error) {
                currentConfig = { fields: {}, groups: {} };
                showStatus('Fehler beim Laden der Konfiguration: ' + error.message, 'error');
            }
        }

        function initializeEditor() {
            buildGroupsOrder();
            buildFieldsOrder();
            renderGroups();
            renderFields();
            initializeSortable();
        }

        function buildGroupsOrder() {
            groupsOrder = Object.keys(currentConfig.groups || {});
            // Standard-Reihenfolge falls keine Gruppen vorhanden
            if (groupsOrder.length === 0) {
                groupsOrder = ['Pers√∂nliche Daten', 'Kontaktdaten', 'Sonstige'];
                groupsOrder.forEach(groupName => {
                    if (!currentConfig.groups) currentConfig.groups = {};
                    if (!currentConfig.groups[groupName]) {
                        currentConfig.groups[groupName] = {
                            title: groupName,
                            description: ''
                        };
                    }
                });
            }
        }

        function buildFieldsOrder() {
            fieldsOrder = {};
            
            // Alle PDF-Felder als Basis
            const allFields = [...currentPDF.fields];
            
            // Bereits gruppierte Felder sammeln
            const assignedFields = new Set();
            
            groupsOrder.forEach(groupName => {
                fieldsOrder[groupName] = [];
                
                // Felder zu Gruppen zuordnen
                allFields.forEach(fieldName => {
                    const fieldConfig = currentConfig.fields[fieldName] || {};
                    if (fieldConfig.group === groupName) {
                        fieldsOrder[groupName].push(fieldName);
                        assignedFields.add(fieldName);
                    }
                });
            });
            
            // Nicht zugewiesene Felder zur 'Sonstige' Gruppe hinzuf√ºgen
            if (!fieldsOrder['Sonstige']) {
                fieldsOrder['Sonstige'] = [];
            }
            
            allFields.forEach(fieldName => {
                if (!assignedFields.has(fieldName)) {
                    fieldsOrder['Sonstige'].push(fieldName);
                    // Feld-Konfiguration erstellen falls nicht vorhanden
                    if (!currentConfig.fields[fieldName]) {
                        currentConfig.fields[fieldName] = {
                            group: 'Sonstige'
                        };
                    } else {
                        currentConfig.fields[fieldName].group = 'Sonstige';
                    }
                }
            });
        }

        function renderGroups() {
            const container = document.getElementById('groupsList');
            container.innerHTML = '';
            
            groupsOrder.forEach(groupName => {
                const fieldCount = fieldsOrder[groupName] ? fieldsOrder[groupName].length : 0;
                const div = document.createElement('div');
                div.className = 'group-item';
                div.dataset.groupName = groupName;
                div.innerHTML = `
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <span class="group-name">${groupName}</span>
                    <span class="group-count">${fieldCount}</span>
                `;
                div.onclick = () => selectGroup(groupName);
                container.appendChild(div);
            });
        }

        function renderFields() {
            const container = document.getElementById('fieldsList');
            const unassignedContainer = document.getElementById('unassignedFieldsList');
            const unassignedSection = document.getElementById('unassignedFields');
            
            container.innerHTML = '';
            unassignedContainer.innerHTML = '';
            
            if (!currentGroup) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Gruppe ausw√§hlen</div>';
                unassignedSection.style.display = 'none';
                return;
            }
            
            const fields = fieldsOrder[currentGroup] || [];
            
            fields.forEach(fieldName => {
                const fieldConfig = currentConfig.fields[fieldName] || {};
                const div = document.createElement('div');
                div.className = 'field-item';
                div.dataset.fieldName = fieldName;
                
                let badges = '';
                if (fieldConfig.type && fieldConfig.type !== 'text') {
                    badges += `<span class="field-type">${fieldConfig.type}</span>`;
                }
                if (fieldConfig.mapping) {
                    badges += `<span class="field-mapped">‚Üí ${fieldConfig.mapping}</span>`;
                }
                if (fieldConfig.hidden_for_pdfs && fieldConfig.hidden_for_pdfs.length > 0) {
                    badges += `<span class="field-hidden">versteckt</span>`;
                }
                
                div.innerHTML = `
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <span class="field-name">${fieldName}</span>
                    ${badges}
                `;
                div.onclick = () => selectField(fieldName);
                container.appendChild(div);
            });
            
            // Nicht zugewiesene Felder (nur anzeigen wenn nicht in 'Sonstige' Gruppe)
            if (currentGroup !== 'Sonstige') {
                const unassignedFields = currentPDF.fields.filter(fieldName => {
                    const fieldConfig = currentConfig.fields[fieldName] || {};
                    return !fieldConfig.group || fieldConfig.group === 'Sonstige';
                });
                
                if (unassignedFields.length > 0) {
                    unassignedFields.forEach(fieldName => {
                        const div = document.createElement('div');
                        div.className = 'field-item';
                        div.dataset.fieldName = fieldName;
                        div.innerHTML = `
                            <span class="field-name">${fieldName}</span>
                            <button onclick="assignFieldToGroup('${fieldName}', '${currentGroup}')" 
                                    style="padding: 2px 6px; font-size: 0.8em; background: #28a745; color: white; border: none; border-radius: 3px;">
                                ‚ûï Hinzuf√ºgen
                            </button>
                        `;
                        unassignedContainer.appendChild(div);
                    });
                    unassignedSection.style.display = 'block';
                } else {
                    unassignedSection.style.display = 'none';
                }
            } else {
                unassignedSection.style.display = 'none';
            }
        }

        function selectGroup(groupName) {
            currentGroup = groupName;
            currentField = null;
            
            // Aktiven Zustand setzen
            document.querySelectorAll('.group-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-group-name="${groupName}"]`).classList.add('active');
            
            // Felder f√ºr diese Gruppe anzeigen
            renderFields();
            
            // Properties Panel aktualisieren
            showGroupProperties(groupName);
            
            // Gruppenname im Felder-Panel anzeigen
            document.getElementById('selectedGroupName').textContent = `(${groupName})`;
        }

        function selectField(fieldName) {
            currentField = fieldName;
            
            // Aktiven Zustand setzen
            document.querySelectorAll('.field-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-field-name="${fieldName}"]`).classList.add('active');
            
            // Properties Panel aktualisieren
            showFieldProperties(fieldName);
        }

        function showGroupProperties(groupName) {
            document.getElementById('groupProperties').classList.add('active');
            document.getElementById('fieldProperties').classList.remove('active');
            
            const groupConfig = currentConfig.groups[groupName] || {};
            document.getElementById('groupTitle').value = groupConfig.title || '';
            document.getElementById('groupDescription').value = groupConfig.description || '';
        }

        function showFieldProperties(fieldName) {
            document.getElementById('fieldProperties').classList.add('active');
            document.getElementById('groupProperties').classList.remove('active');
            
            const fieldConfig = currentConfig.fields[fieldName] || {};
            document.getElementById('fieldTitle').value = fieldConfig.title || '';
            document.getElementById('fieldDescription').value = fieldConfig.description || '';
            document.getElementById('fieldType').value = fieldConfig.type || 'text';
            document.getElementById('fieldMapping').value = fieldConfig.mapping || '';
            document.getElementById('fieldCalculation').value = fieldConfig.berechnung || '';
            document.getElementById('fieldHidden').checked = (fieldConfig.hidden_for_pdfs && fieldConfig.hidden_for_pdfs.length > 0) || false;
        }

        function initializeSortable() {
            // Sortable f√ºr Gruppen
            new Sortable(document.getElementById('groupsList'), {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                onEnd: function(evt) {
                    const newOrder = Array.from(evt.to.children).map(el => el.dataset.groupName);
                    groupsOrder = newOrder;
                    saveCurrentProperties();
                }
            });
            
            // Sortable f√ºr Felder
            new Sortable(document.getElementById('fieldsList'), {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                onEnd: function(evt) {
                    if (currentGroup) {
                        const newOrder = Array.from(evt.to.children).map(el => el.dataset.fieldName);
                        fieldsOrder[currentGroup] = newOrder;
                        saveCurrentProperties();
                    }
                }
            });
        }

        function addNewGroup() {
            const groupName = prompt('Name der neuen Gruppe:');
            if (!groupName || groupName.trim() === '') return;
            
            const trimmedName = groupName.trim();
            if (groupsOrder.includes(trimmedName)) {
                alert('Eine Gruppe mit diesem Namen existiert bereits!');
                return;
            }
            
            // Neue Gruppe hinzuf√ºgen
            currentConfig.groups[trimmedName] = {
                title: trimmedName,
                description: ''
            };
            groupsOrder.push(trimmedName);
            fieldsOrder[trimmedName] = [];
            
            renderGroups();
            selectGroup(trimmedName);
            showStatus('Neue Gruppe erstellt: ' + trimmedName, 'success');
        }

        function deleteGroup() {
            if (!currentGroup) return;
            
            if (currentGroup === 'Sonstige') {
                alert('Die Gruppe "Sonstige" kann nicht gel√∂scht werden!');
                return;
            }
            
            if (!confirm(`Gruppe "${currentGroup}" wirklich l√∂schen?\n\nAlle Felder werden zur Gruppe "Sonstige" verschoben.`)) {
                return;
            }
            
            // Felder zur 'Sonstige' Gruppe verschieben
            const fieldsToMove = fieldsOrder[currentGroup] || [];
            fieldsToMove.forEach(fieldName => {
                if (currentConfig.fields[fieldName]) {
                    currentConfig.fields[fieldName].group = 'Sonstige';
                }
            });
            
            if (!fieldsOrder['Sonstige']) fieldsOrder['Sonstige'] = [];
            fieldsOrder['Sonstige'].push(...fieldsToMove);
            
            // Gruppe l√∂schen
            delete currentConfig.groups[currentGroup];
            delete fieldsOrder[currentGroup];
            groupsOrder = groupsOrder.filter(name => name !== currentGroup);
            
            currentGroup = null;
            currentField = null;
            
            renderGroups();
            renderFields();
            document.getElementById('groupProperties').classList.remove('active');
            document.getElementById('fieldProperties').classList.remove('active');
            
            showStatus('Gruppe gel√∂scht', 'success');
        }

        function assignFieldToGroup(fieldName, groupName) {
            // Feld aus alter Gruppe entfernen
            Object.keys(fieldsOrder).forEach(group => {
                fieldsOrder[group] = fieldsOrder[group].filter(name => name !== fieldName);
            });
            
            // Feld zur neuen Gruppe hinzuf√ºgen
            if (!fieldsOrder[groupName]) fieldsOrder[groupName] = [];
            fieldsOrder[groupName].push(fieldName);
            
            // Feld-Konfiguration aktualisieren
            if (!currentConfig.fields[fieldName]) {
                currentConfig.fields[fieldName] = {};
            }
            currentConfig.fields[fieldName].group = groupName;
            
            renderGroups();
            renderFields();
            showStatus(`Feld "${fieldName}" zu Gruppe "${groupName}" hinzugef√ºgt`, 'success');
        }

        function saveCurrentProperties() {
            // Gruppen-Eigenschaften speichern
            if (currentGroup && document.getElementById('groupProperties').classList.contains('active')) {
                const groupConfig = currentConfig.groups[currentGroup] || {};
                groupConfig.title = document.getElementById('groupTitle').value;
                groupConfig.description = document.getElementById('groupDescription').value;
                currentConfig.groups[currentGroup] = groupConfig;
            }
            
            // Feld-Eigenschaften speichern
            if (currentField && document.getElementById('fieldProperties').classList.contains('active')) {
                const fieldConfig = currentConfig.fields[currentField] || {};
                fieldConfig.title = document.getElementById('fieldTitle').value;
                fieldConfig.description = document.getElementById('fieldDescription').value;
                fieldConfig.type = document.getElementById('fieldType').value;
                fieldConfig.mapping = document.getElementById('fieldMapping').value;
                fieldConfig.berechnung = document.getElementById('fieldCalculation').value;
                fieldConfig.group = currentGroup;
                
                // Hidden-Status
                const isHidden = document.getElementById('fieldHidden').checked;
                if (isHidden) {
                    fieldConfig.hidden_for_pdfs = [currentPDF.name];
                } else {
                    delete fieldConfig.hidden_for_pdfs;
                }
                
                // Leere Werte entfernen
                Object.keys(fieldConfig).forEach(key => {
                    if (fieldConfig[key] === '' || fieldConfig[key] === null || fieldConfig[key] === undefined) {
                        delete fieldConfig[key];
                    }
                });
                
                currentConfig.fields[currentField] = fieldConfig;
                
                // Felder neu rendern um Badges zu aktualisieren
                renderFields();
            }
        }

        // Event-Listener f√ºr Eigenschaften-√Ñnderungen
        document.addEventListener('DOMContentLoaded', function() {
            // Gruppen-Eigenschaften
            document.getElementById('groupTitle').addEventListener('input', saveCurrentProperties);
            document.getElementById('groupDescription').addEventListener('input', saveCurrentProperties);
            
            // Feld-Eigenschaften
            document.getElementById('fieldTitle').addEventListener('input', saveCurrentProperties);
            document.getElementById('fieldDescription').addEventListener('input', saveCurrentProperties);
            document.getElementById('fieldType').addEventListener('change', saveCurrentProperties);
            document.getElementById('fieldMapping').addEventListener('input', saveCurrentProperties);
            document.getElementById('fieldCalculation').addEventListener('input', saveCurrentProperties);
            document.getElementById('fieldHidden').addEventListener('change', saveCurrentProperties);
        });

        function buildFinalConfig() {
            saveCurrentProperties();
            
            const finalConfig = {
                groups: {},
                fields: {}
            };
            
            // Gruppen in richtiger Reihenfolge
            groupsOrder.forEach(groupName => {
                if (currentConfig.groups[groupName]) {
                    finalConfig.groups[groupName] = { ...currentConfig.groups[groupName] };
                }
            });
            
            // Felder mit Gruppenzuordnung
            Object.keys(currentConfig.fields).forEach(fieldName => {
                const fieldConfig = { ...currentConfig.fields[fieldName] };
                
                // Gruppe basierend auf fieldsOrder setzen
                for (const [groupName, fields] of Object.entries(fieldsOrder)) {
                    if (fields.includes(fieldName)) {
                        fieldConfig.group = groupName;
                        break;
                    }
                }
                
                finalConfig.fields[fieldName] = fieldConfig;
            });
            
            return finalConfig;
        }

        function saveConfig() {
            if (!currentPDF) {
                showStatus('Kein PDF ausgew√§hlt!', 'error');
                return;
            }
            
            const config = buildFinalConfig();
            const yamlString = jsyaml.dump(config, {
                indent: 2,
                lineWidth: -1,
                noRefs: true,
                sortKeys: false
            });
            
            console.log('Generierte Konfiguration:', config);
            console.log('YAML:', yamlString);
            
            showStatus('Konfiguration wurde generiert! (Siehe Konsole f√ºr Details)', 'success');
        }

        function downloadConfig() {
            if (!currentPDF) {
                showStatus('Kein PDF ausgew√§hlt!', 'error');
                return;
            }
            
            const config = buildFinalConfig();
            const yamlString = jsyaml.dump(config, {
                indent: 2,
                lineWidth: -1,
                noRefs: true,
                sortKeys: false
            });
            
            const blob = new Blob([yamlString], { type: 'text/yaml' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = currentPDF.name.replace('.pdf', '.yaml');
            link.click();
            
            showStatus('YAML-Datei wurde heruntergeladen!', 'success');
        }

        function previewConfig() {
            if (!currentPDF) {
                showStatus('Kein PDF ausgew√§hlt!', 'error');
                return;
            }
            
            const config = buildFinalConfig();
            const yamlString = jsyaml.dump(config, {
                indent: 2,
                lineWidth: -1,
                noRefs: true,
                sortKeys: false
            });
            
            const previewWindow = window.open('', '_blank', 'width=800,height=600');
            previewWindow.document.write(`
                <html>
                <head>
                    <title>Konfiguration Vorschau - ${currentPDF.name}</title>
                    <style>
                        body { font-family: monospace; margin: 20px; background: #f5f5f5; }
                        pre { background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; overflow: auto; }
                        h1 { color: #333; }
                    </style>
                </head>
                <body>
                    <h1>Konfiguration f√ºr ${currentPDF.name}</h1>
                    <pre>${yamlString}</pre>
                </body>
                </html>
            `);
        }

        function showStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>