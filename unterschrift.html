<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unterschrift-Komponente Test</title>
    <style>
        .signature-field {
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9ff;
        }

        .signature-preview {
            width: 100%;
            max-width: 400px;
            height: 150px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }

        .signature-preview.has-signature {
            border-color: #5a7c47;
            border-style: solid;
        }

        .signature-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .signature-canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .signature-placeholder {
            color: #999;
            text-align: center;
            padding: 20px;
        }

        .signature-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .signature-controls button {
            padding: 8px 16px;
            border: 1px solid #5a7c47;
            background: white;
            color: #5a7c47;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .signature-controls button:hover {
            background: #5a7c47;
            color: white;
        }

        .signature-controls button.primary {
            background: #5a7c47;
            color: white;
        }

        .signature-controls input[type="file"] {
            display: none;
        }

        .signature-mode-tabs {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #e1e5e9;
        }

        .signature-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
            color: #666;
        }

        .signature-tab.active {
            color: #5a7c47;
            border-bottom-color: #5a7c47;
        }

        .signature-content {
            display: none;
        }

        .signature-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div style="padding: 20px; max-width: 500px; margin: 0 auto;">
        <h2>Unterschrift-Komponente</h2>
        
        <div class="signature-field">
            <label>Unterschrift</label>
            <div class="field-description">Zeichnen Sie Ihre Unterschrift oder laden Sie ein Bild hoch</div>
            
            <div class="signature-mode-tabs">
                <button class="signature-tab active" onclick="switchSignatureMode('draw', 'test')">‚úèÔ∏è Zeichnen</button>
                <button class="signature-tab" onclick="switchSignatureMode('upload', 'test')">üìÅ Hochladen</button>
            </div>
            
            <div id="signature-draw-test" class="signature-content active">
                <div class="signature-preview">
                    <canvas id="signature-canvas-test" class="signature-canvas" width="400" height="150"></canvas>
                </div>
                <div class="signature-controls">
                    <button onclick="clearSignature('test')">üóëÔ∏è L√∂schen</button>
                    <button onclick="undoSignature('test')">‚Ü∂ R√ºckg√§ngig</button>
                </div>
            </div>
            
            <div id="signature-upload-test" class="signature-content">
                <div class="signature-preview" id="signature-preview-test">
                    <div class="signature-placeholder">Klicken Sie hier oder ziehen Sie ein Bild hinein</div>
                </div>
                <div class="signature-controls">
                    <label for="signature-file-test" style="margin: 0;">
                        <button type="button">üìÅ Datei ausw√§hlen</button>
                    </label>
                    <input type="file" id="signature-file-test" accept="image/*" onchange="uploadSignature('test', this)">
                    <button onclick="clearSignature('test')">üóëÔ∏è L√∂schen</button>
                </div>
            </div>
            
            <input type="hidden" id="signature-data-test" name="signature-test" value="">
        </div>
        
        <div style="margin-top: 20px;">
            <button onclick="showSignatureData()">Daten anzeigen</button>
            <button onclick="testSignatureInPDF()">In PDF testen</button>
        </div>
        
        <div id="output" style="margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px; display: none;">
            <h3>Unterschrift-Daten:</h3>
            <textarea readonly style="width: 100%; height: 100px;"></textarea>
        </div>
    </div>

    <script>
        // Globale Unterschrift-Verwaltung
        window.signatures = new Map();
        
        class SignatureManager {
            constructor(fieldId) {
                this.fieldId = fieldId;
                this.canvas = document.getElementById(`signature-canvas-${fieldId}`);
                this.ctx = this.canvas ? this.canvas.getContext('2d') : null;
                this.isDrawing = false;
                this.paths = [];
                this.currentPath = [];
                
                if (this.canvas) {
                    this.setupCanvas();
                }
            }
            
            setupCanvas() {
                const rect = this.canvas.getBoundingClientRect();
                const scale = window.devicePixelRatio || 1;
                
                this.canvas.width = 400 * scale;
                this.canvas.height = 150 * scale;
                this.canvas.style.width = '400px';
                this.canvas.style.height = '150px';
                
                this.ctx.scale(scale, scale);
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                this.ctx.strokeStyle = '#000';
                this.ctx.lineWidth = 2;
                
                // Event Listeners
                this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
                this.canvas.addEventListener('mousemove', (e) => this.draw(e));
                this.canvas.addEventListener('mouseup', () => this.stopDrawing());
                this.canvas.addEventListener('mouseout', () => this.stopDrawing());
                
                // Touch Events
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const mouseEvent = new MouseEvent('mousedown', {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    this.canvas.dispatchEvent(mouseEvent);
                });
                
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const mouseEvent = new MouseEvent('mousemove', {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    this.canvas.dispatchEvent(mouseEvent);
                });
                
                this.canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    const mouseEvent = new MouseEvent('mouseup', {});
                    this.canvas.dispatchEvent(mouseEvent);
                });
            }
            
            getCanvasPosition(e) {
                const rect = this.canvas.getBoundingClientRect();
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }
            
            startDrawing(e) {
                this.isDrawing = true;
                const pos = this.getCanvasPosition(e);
                this.currentPath = [pos];
                this.ctx.beginPath();
                this.ctx.moveTo(pos.x, pos.y);
            }
            
            draw(e) {
                if (!this.isDrawing) return;
                
                const pos = this.getCanvasPosition(e);
                this.currentPath.push(pos);
                this.ctx.lineTo(pos.x, pos.y);
                this.ctx.stroke();
            }
            
            stopDrawing() {
                if (!this.isDrawing) return;
                this.isDrawing = false;
                
                if (this.currentPath.length > 1) {
                    this.paths.push([...this.currentPath]);
                    this.updateSignatureData();
                }
                this.currentPath = [];
            }
            
            clear() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.paths = [];
                this.updateSignatureData();
            }
            
            undo() {
                if (this.paths.length > 0) {
                    this.paths.pop();
                    this.redrawCanvas();
                    this.updateSignatureData();
                }
            }
            
            redrawCanvas() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.paths.forEach(path => {
                    if (path.length > 1) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(path[0].x, path[0].y);
                        for (let i = 1; i < path.length; i++) {
                            this.ctx.lineTo(path[i].x, path[i].y);
                        }
                        this.ctx.stroke();
                    }
                });
            }
            
            updateSignatureData() {
                const dataUrl = this.canvas.toDataURL('image/png');
                const hiddenInput = document.getElementById(`signature-data-${this.fieldId}`);
                if (hiddenInput) {
                    hiddenInput.value = dataUrl;
                }
                
                // Trigger change event f√ºr Formular-Integration
                hiddenInput.dispatchEvent(new Event('change'));
            }
            
            setImageData(dataUrl) {
                const img = new Image();
                img.onload = () => {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // Bild proportional einpassen
                    const canvasRatio = this.canvas.width / this.canvas.height;
                    const imgRatio = img.width / img.height;
                    
                    let drawWidth, drawHeight, offsetX = 0, offsetY = 0;
                    
                    if (imgRatio > canvasRatio) {
                        drawWidth = this.canvas.width;
                        drawHeight = drawWidth / imgRatio;
                        offsetY = (this.canvas.height - drawHeight) / 2;
                    } else {
                        drawHeight = this.canvas.height;
                        drawWidth = drawHeight * imgRatio;
                        offsetX = (this.canvas.width - drawWidth) / 2;
                    }
                    
                    this.ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
                    this.updateSignatureData();
                };
                img.src = dataUrl;
            }
        }
        
        function switchSignatureMode(mode, fieldId) {
            // Tab-Aktivierung
            document.querySelectorAll(`#signature-draw-${fieldId}, #signature-upload-${fieldId}`).forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.signature-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(`signature-${mode}-${fieldId}`).classList.add('active');
            event.target.classList.add('active');
        }
        
        function clearSignature(fieldId) {
            // Canvas l√∂schen
            if (window.signatures.has(fieldId)) {
                window.signatures.get(fieldId).clear();
            }
            
            // Upload-Preview l√∂schen
            const preview = document.getElementById(`signature-preview-${fieldId}`);
            if (preview) {
                preview.innerHTML = '<div class="signature-placeholder">Klicken Sie hier oder ziehen Sie ein Bild hinein</div>';
                preview.classList.remove('has-signature');
            }
            
            // Hidden input l√∂schen
            const hiddenInput = document.getElementById(`signature-data-${fieldId}`);
            if (hiddenInput) {
                hiddenInput.value = '';
                hiddenInput.dispatchEvent(new Event('change'));
            }
        }
        
        function undoSignature(fieldId) {
            if (window.signatures.has(fieldId)) {
                window.signatures.get(fieldId).undo();
            }
        }
        
        function uploadSignature(fieldId, input) {
            const file = input.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Bitte w√§hlen Sie eine Bilddatei aus.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                
                // Preview aktualisieren
                const preview = document.getElementById(`signature-preview-${fieldId}`);
                if (preview) {
                    preview.innerHTML = `<img src="${dataUrl}" alt="Unterschrift">`;
                    preview.classList.add('has-signature');
                }
                
                // Hidden input aktualisieren
                const hiddenInput = document.getElementById(`signature-data-${fieldId}`);
                if (hiddenInput) {
                    hiddenInput.value = dataUrl;
                    hiddenInput.dispatchEvent(new Event('change'));
                }
                
                // Canvas aktualisieren (falls im Draw-Modus)
                if (window.signatures.has(fieldId)) {
                    window.signatures.get(fieldId).setImageData(dataUrl);
                }
            };
            reader.readAsDataURL(file);
        }
        
        function initializeSignature(fieldId) {
            if (!window.signatures.has(fieldId)) {
                window.signatures.set(fieldId, new SignatureManager(fieldId));
            }
            
            // Drag & Drop f√ºr Upload-Bereich
            const preview = document.getElementById(`signature-preview-${fieldId}`);
            if (preview) {
                preview.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    preview.style.borderColor = '#5a7c47';
                    preview.style.backgroundColor = '#f0f8ff';
                });
                
                preview.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    preview.style.borderColor = '#ccc';
                    preview.style.backgroundColor = 'white';
                });
                
                preview.addEventListener('drop', (e) => {
                    e.preventDefault();
                    preview.style.borderColor = '#ccc';
                    preview.style.backgroundColor = 'white';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const input = document.getElementById(`signature-file-${fieldId}`);
                        input.files = files;
                        uploadSignature(fieldId, input);
                    }
                });
                
                preview.addEventListener('click', () => {
                    document.getElementById(`signature-file-${fieldId}`).click();
                });
            }
        }
        
        // Test-Funktionen
        function showSignatureData() {
            const data = document.getElementById('signature-data-test').value;
            const output = document.getElementById('output');
            const textarea = output.querySelector('textarea');
            
            if (data) {
                textarea.value = data.substring(0, 100) + '... (Base64 Data)';
                output.style.display = 'block';
            } else {
                alert('Keine Unterschrift vorhanden');
            }
        }
        
        function testSignatureInPDF() {
            const data = document.getElementById('signature-data-test').value;
            if (!data) {
                alert('Bitte erstellen Sie zuerst eine Unterschrift');
                return;
            }
            
            alert('Unterschrift-Daten sind bereit f√ºr PDF-Integration!\n\nDie Unterschrift wird als Base64-String in den Formulardaten gespeichert.');
        }
        
        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            initializeSignature('test');
        });
    </script>
</body>
</html>